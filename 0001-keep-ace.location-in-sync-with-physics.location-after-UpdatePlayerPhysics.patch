From 5aaa384dc87604c86375740374403a0aad9a032b Mon Sep 17 00:00:00 2001
From: gmriggs <gmriggs@gmail.com>
Date: Sun, 5 Dec 2021 12:05:06 -0500
Subject: [PATCH] keep ace.location in sync with physics.location after
 UpdatePlayerPhysics()

---
 Source/ACE.Server/WorldObjects/Player_Tick.cs | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/Source/ACE.Server/WorldObjects/Player_Tick.cs b/Source/ACE.Server/WorldObjects/Player_Tick.cs
index 53c145776..309a63c0d 100644
--- a/Source/ACE.Server/WorldObjects/Player_Tick.cs
+++ b/Source/ACE.Server/WorldObjects/Player_Tick.cs
@@ -280,7 +280,7 @@ public override bool UpdateObjectPhysics()
 
                 if (FastTick && PhysicsObj.IsMovingOrAnimating || PhysicsObj.Velocity != Vector3.Zero)
                 {
-                    UpdatePlayerPhysics();
+                    landblockUpdate |= UpdatePlayerPhysics();
 
                     if (MoveToParams?.Callback != null && !PhysicsObj.IsMovingOrAnimating)
                         HandleMoveToCallback();
@@ -301,8 +301,10 @@ public override bool UpdateObjectPhysics()
             }
         }
 
-        public void UpdatePlayerPhysics()
+        public bool UpdatePlayerPhysics()
         {
+            var landblockUpdate = false;
+
             if (DebugPlayerMoveToStatePhysics)
                 Console.WriteLine($"{Name}.UpdatePlayerPhysics({PhysicsObj.PartArray.Sequence.CurrAnim.Value.Anim.ID:X8})");
 
@@ -312,9 +314,10 @@ public void UpdatePlayerPhysics()
             PhysicsObj.update_object();
 
             // sync ace position?
-            Location.Rotation = PhysicsObj.Position.Frame.Orientation;
+            landblockUpdate = SyncLocationWithPhysics();
+            //Location.Rotation = PhysicsObj.Position.Frame.Orientation;
 
-            if (!FastTick) return;
+            if (!FastTick) return landblockUpdate;
 
             // ensure PKLogout position is synced up for other players
             if (PKLogout)
@@ -361,6 +364,8 @@ public void UpdatePlayerPhysics()
 
             if (MagicState.IsCasting && MagicState.PendingTurnRelease)
                 CheckTurn();
+
+            return landblockUpdate;
         }
 
         /// <summary>
-- 
2.32.0.windows.1

